<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/favicon.png">
    <title>Loot & Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&display=swap" rel="stylesheet">
    <script src="https://raw.githubusercontent.com/Da-CaRo/site-configs/main/control.js" data-web="loot-and-run"></script>

    <style>
        /* 1. DEFINICI√ìN DE VARIABLES DE COLOR */
        :root {
            --color-acento: #2dffeb;
            /* Turquesa vibrante */
            --color-fondo: #0f172a;
            /* Un azul pizarra muy oscuro (slate-900) */
            --color-tarjeta: #1e293b;
            /* Un tono m√°s claro para las tarjetas (slate-800) */
            --color-texto: #f8fafc;
            /* Blanco azulado muy limpio */
            --color-texto-tarjeta: #94a3b8;
            /* Gris suave para descripciones */
            --color-borde-tarjeta: #334155;
            /* Bordes sutiles */
        }

        /* 2. APLICACI√ìN DE VARIABLES A LOS ESTILOS GLOBALMENTE */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--color-fondo);
            /* Usando variable */
            color: var(--color-texto);
            /* Usando variable */
        }

        /* Para usar una fuente monoespaciada en t√≠tulos espec√≠ficos */
        .font-code {
            font-family: 'Space Mono', ui-monospace, SFMono-Regular, monospace;
        }

        .font-loot-and-run {
            font-family: 'Bungee Shade', sans-serif;
            text-transform: uppercase;
        }

        /* Sobrescribir las clases de Tailwind con las variables (para el color de acento) */
        .text-loot-and-run {
            /* Aplicaci√≥n del Gradiente */
            background: linear-gradient(45deg,
                    var(--color-acento) 20%,
                    #8f54b3 40%,
                    #fcba49 60%,
                    #2c75e3 90%);

            /* Truco para que el fondo solo pinte el texto */
            -webkit-background-clip: text;
            background-clip: text;

            /* Hacemos transparente el color original de la fuente para ver el gradiente */
            color: transparent;

            filter: drop-shadow(0 0 8px rgba(30, 200, 197, 0.3));
            line-height: 1.2;
            display: inline-block;
            /* Asegura que el gradiente se calcule bien */
        }

        .text-acento {
            color: var(--color-acento);
        }

        .hover-acento:hover {
            color: var(--color-acento);
        }

        .bg-tarjeta {
            background-color: var(--color-tarjeta);
        }

        .border-tarjeta {
            border-color: var(--color-borde-tarjeta);
        }

        .border-tarjeta:hover {
            border-color: var(--color-acento);
        }

        .text-tarjeta {
            color: var(--color-texto-tarjeta);
        }


        #players-list-display {
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
    </style>
</head>

<body class="min-h-screen antialiased">
    <header class="bg-gray-900 shadow-md p-4 border-b border-gray-800 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center py-0">
            <div class="flex items-center space-x-2">
                <img src="img/favicon.png" alt="Icono Loot And Run" class="h-8 w-8">
                <h1 class="text-3xl font-extrabold text-loot-and-run font-loot-and-run">
                    Loot & Run
                </h1>
            </div>

            <div id="nav-actions" class="flex items-center space-x-6">
                <div id="action-buttons"></div>
                <div id="game-progress"
                    class="hidden flex items-center bg-gray-800 px-4 py-1.5 rounded-full border border-gray-700 shadow-inner">
                    <span class="text-xs font-bold text-tarjeta mr-3 uppercase tracking-wider">Progreso</span>
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-center">
                            <span id="round-count" class="text-acento font-loot-and-run text-lg leading-none">1/5</span>
                            <span class="text-[8px] text-gray-500 uppercase">Ronda</span>
                        </div>
                    </div>
                </div>
            </div>

            <button id="reset-game-btn"
                class="py-2 px-4 bg-gray-700 hover:bg-gray-600 text-red-400 font-bold rounded-lg transition duration-150 items-center justify-center text-base disabled:opacity-50 hidden"
                title="Acabar Partida">
                üõë Salir
            </button>
        </div>
    </header>
    <div id="start-buttons">
        <div class="py-8 md:py-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">

                <h1 class="text-5xl md:text-6xl font-extrabold mb-4">
                    Sintoniza tu percepci√≥n en el <span class="font-loot-and-run text-loot-and-run">espectro</span>
                </h1>
                <p class="text-xl text-tarjeta mb-12 max-w-2xl mx-auto">
                    Ad√©ntrate en la cueva, roba el bot√≠n y escapa antes de que sea tarde.
                </p>
            </div>

            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

                    <div
                        class="bg-tarjeta p-6 rounded-lg shadow-xl border border-tarjeta transition duration-300 h-full flex flex-col justify-between">
                        <div>
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-loot-and-run text-4xl block">‚öôÔ∏è</span>
                                <h3 class="text-4xl font-bold">Opciones</h3>
                            </div>
                            <p class="text-tarjeta text-base">
                            <div class="flex flex-col space-y-2 mb-4">
                                <label
                                    class="text-sm font-bold text-tarjeta uppercase tracking-widest text-center">Configurar
                                    Jugadores</label>

                                <div class="flex space-x-2">
                                    <input type="text" id="player-name-input" placeholder="Introduce nombre (m√°x. 10)"
                                        class="flex-1 p-3 bg-gray-700 border border-acento text-white rounded-lg focus:outline-none placeholder-gray-400"
                                        maxlength="15"> <button id="add-player-btn"
                                        class="shrink-0 bg-[--color-acento] text-white font-bold p-3 rounded-lg transition duration-150">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </div>

                                <button id="start-btn" disabled
                                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-150">
                                    Empezar (m√≠n. 3)
                                </button>
                            </div>
                            </p>
                        </div>
                        <a href="#" target="_blank" class="block">
                            <span class="mt-5 inline-block text-sm font-medium text-loot-and-run hover:underline">Ver
                                Instrucciones ‚Üí</span></a>
                    </div>

                    <div
                        class="bg-tarjeta p-6 rounded-lg shadow-xl border border-tarjeta transition duration-300 h-full flex flex-col justify-between lg:col-span-2">
                        <div>
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-loot-and-run text-4xl block">‚öôÔ∏è</span>
                                <h3 class="text-4xl font-bold">Jugadores</h3>
                            </div>
                            <p class="text-tarjeta text-base">
                            <div class="flex flex-col space-y-2 mb-4">

                                <div id="players-list-display"
                                    class="flex flex-wrap gap-2 min-h-[40px] p-2 bg-gray-900/50 rounded-lg border border-dashed border-gray-700">
                                </div>

                            </div>
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <main class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">

        <div id="game-layout" class="flex flex-col lg:flex-row lg:space-x-4 hidden">

            <div id="control-bar-wrapper"
                class="flex flex-col sm:flex-row lg:flex-col justify-between items-center w-full lg:w-64 mb-6 lg:mb-0">
                <div id="game-stats" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-1 gap-3 w-full hidden">

                </div>

            </div>

            <div id="game-board" class="grid gap-0.5 w-full lg:flex-1 bg-gray-800 p-1 rounded shadow-2xl ">

            </div>
        </div>

        </div>
    </main>

    <footer class="bg-gray-900 border-t border-gray-800 mt-16 py-4">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">

                <p class="text-xs text-tarjeta mb-4 md:mb-0">
                    &copy; <span id="currentYearFooter"></span> <span class="font-code">
                        Da_CaRo
                    </span>
                </p>

                <div class="flex space-x-6 items-center">
                    <a href="https://da-caro.github.io/labs" target="_blank"
                        class="text-tarjeta hover-acento transition duration-300 text-sm">
                        Labs
                    </a>
                    <a href="https://github.com/da-caro" target="_blank"
                        class="text-tarjeta hover-acento transition duration-300 text-sm">
                        GitHub
                    </a>
                    <button id="clear-storage-btn" class="text-tarjeta hover-acento transition duration-300 text-sm">
                        Borrar Variables
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <div id="guide-modal" class="hidden fixed inset-0 bg-black/85 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-2xl max-w-sm w-full text-center border-2 border-acento shadow-2xl">
        </div>
    </div>
    <script type="module">
        document.getElementById('currentYearFooter').textContent = new Date().getFullYear();

        let listaJugadores = [];
        let rondaActual = 1;
        const MAX_RONDAS = 3;


        // --- L√≥gica del Juego ---

        // --- Integraci√≥n con los clics ---

        // Bot√≥n de inicio
        // Configurar jugadores al empezar
        const coloresJugadores = [
            { nombre: 'Rojo', hex: '#ef4444' },
            { nombre: 'Azul', hex: '#3b82f6' },
            { nombre: 'Verde', hex: '#22c55e' },
            { nombre: 'Amarillo', hex: '#eab308' },
            { nombre: 'Rosa', hex: '#ec4899' },
            { nombre: 'Naranja', hex: '#f97316' },
            { nombre: 'Cian', hex: '#06b6d4' },
            { nombre: 'Morado', hex: '#a855f7' },
            { nombre: 'Lima', hex: '#84cc16' },
            { nombre: 'Blanco', hex: '#f8fafc' }
        ];

        document.getElementById('start-btn').addEventListener('click', () => {
            listaJugadores = [...jugadoresTemporales];

            document.getElementById('start-buttons').classList.add('hidden');
            document.getElementById('game-layout').classList.remove('hidden');
            document.getElementById('game-stats').classList.remove('hidden');
            document.getElementById('reset-game-btn').classList.remove('hidden');

            generateBoard();
            iniciarRonda();
            actualizarProgresoNav();
            guardarPartida()
        });


        const guideModal = document.getElementById('guide-modal');
        const targetPreview = document.getElementById('target-preview');
        const closeModalBtn = document.getElementById('close-modal-btn');


        function iniciarRonda() {
            votosRealizados = 0;
            jugadorActualVotando = (indiceGuiaActual + 1) % listaJugadores.length;

            const guia = listaJugadores[indiceGuiaActual];
            actualizarMarcador();
            actualizarProgresoNav();

            // ALERT DE PRIVACIDAD
            // Usamos setTimeout para asegurar que el marcador se actualice antes del alert
            setTimeout(() => {
                alert(`¬°ATENCI√ìN!\n\nEs el turno de ${guia.nombre} como Gu√≠a.\n\nAseg√∫rate de que nadie m√°s est√© mirando la pantalla antes de pulsar Aceptar.`);
                seleccionarColorSecreto();
            }, 100);
        }

        function actualizarProgresoNav() {
            const progressContainer = document.getElementById('game-progress');
            const roundText = document.getElementById('round-count');
            const guideText = document.getElementById('guide-count');

            // Comprobamos que los elementos existan antes de actuar
            if (progressContainer && roundText && guideText && listaJugadores.length > 0) {
                progressContainer.classList.remove('hidden');
                roundText.textContent = `${rondaActual}/${MAX_RONDAS}`;
                const guiasCompletados = (indiceGuiaActual % listaJugadores.length) + 1;
                guideText.textContent = `${guiasCompletados}/${listaJugadores.length}`;
            }
        }

        // Tambi√©n el bot√≥n de "Salir" del header
        document.getElementById('reset-game-btn').onclick = () => {
            if (confirm("¬øDeseas abandonar la partida actual?")) {
                localStorage.removeItem('loot_and_run_game_state');
                location.reload();
            }
        };


        let jugadoresTemporales = [];

        function actualizarVistaPreviaJugadores() {
            const container = document.getElementById('players-list-display');
            const startBtn = document.getElementById('start-btn');
            container.innerHTML = '';

            jugadoresTemporales.forEach((jugador, index) => {
                const badge = document.createElement('div');
                // El contenedor entero es el que se mueve
                badge.draggable = true;
                badge.className = 'flex items-center space-x-1 px-3 py-1.5 rounded-full text-xs font-black transition-all duration-200 shadow-sm select-none';
                badge.style.backgroundColor = jugador.color;
                badge.style.color = '#0f172a';

                badge.innerHTML = `
            <span class="cursor-grab active:cursor-grabbing opacity-50 hover:opacity-100 px-1 text-lg drag-handle">‚ãÆ‚ãÆ</span>
            
            <span class="flex-1 py-1 cursor-pointer hover:underline name-zone px-1" draggable="false">${jugador.nombre}</span>
            
            <button class="opacity-40 hover:opacity-100 hover:text-white transition-opacity text-xl px-2 cursor-pointer delete-btn" 
                    type="button" style="background:none; border:none; color:inherit; font-weight:bold;">√ó</button>
        `;

                const zonaNombre = badge.querySelector('.name-zone');
                const btnEliminar = badge.querySelector('.delete-btn');

                // --- 1. L√ìGICA DE COLOR (Ahora funciona siempre) ---
                zonaNombre.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    let colorIndex = coloresJugadores.findIndex(c => c.hex === jugador.color);
                    colorIndex = (colorIndex + 1) % coloresJugadores.length;
                    jugador.color = coloresJugadores[colorIndex].hex;

                    // Actualizaci√≥n visual inmediata
                    badge.style.backgroundColor = jugador.color;
                    guardarNombresTemporales();
                };

                // --- 2. L√ìGICA DE ELIMINAR ---
                btnEliminar.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.eliminarJugadorTemporal(index);
                };

                // --- 3. L√ìGICA DE ARRASTRE ---
                badge.addEventListener('dragstart', (e) => {
                    // Si el usuario pincha en el nombre o en el bot√≥n eliminar, CANCELAMOS el drag
                    // para permitir que el evento 'onclick' del color funcione.
                    if (e.target.classList.contains('name-zone') || e.target.closest('.delete-btn')) {
                        e.preventDefault();
                        return;
                    }

                    // Solo permitimos arrastrar si se agarra desde el badge o el handle
                    e.dataTransfer.setData('text/plain', index);
                    badge.style.opacity = '0.5';
                });

                badge.addEventListener('dragend', () => {
                    badge.style.opacity = '1';
                });

                badge.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    badge.classList.add('scale-105', 'ring-2', 'ring-white/20');
                });

                badge.addEventListener('dragleave', () => {
                    badge.classList.remove('scale-105', 'ring-2', 'ring-white/20');
                });

                badge.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = e.dataTransfer.getData('text/plain');
                    const toIndex = index;
                    if (fromIndex !== "" && fromIndex !== toIndex.toString()) {
                        const movedItem = jugadoresTemporales.splice(fromIndex, 1)[0];
                        jugadoresTemporales.splice(toIndex, 0, movedItem);
                        actualizarVistaPreviaJugadores();
                        guardarNombresTemporales();
                    }
                });

                container.appendChild(badge);
            });

            // Validaci√≥n del bot√≥n de inicio
            if (jugadoresTemporales.length >= 3 && jugadoresTemporales.length <= 10) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function eliminarJugadorTemporal(index) {
            jugadoresTemporales.splice(index, 1);
            actualizarVistaPreviaJugadores();
            guardarNombresTemporales();
        }

        window.eliminarJugadorTemporal = eliminarJugadorTemporal;

        // Actualiza tu bot√≥n de a√±adir
        document.getElementById('add-player-btn').onclick = () => {
            const input = document.getElementById('player-name-input');
            const nombre = input.value.trim();

            if (nombre && jugadoresTemporales.length < 10) {
                const colorAsignado = coloresJugadores[jugadoresTemporales.length % coloresJugadores.length].hex;

                jugadoresTemporales.push({
                    id: Date.now(), // Usamos timestamp para ID √∫nico
                    nombre: nombre,
                    color: colorAsignado,
                    puntos: 0
                });

                input.value = '';
                actualizarVistaPreviaJugadores();
                guardarNombresTemporales(); // <--- GUARDAR AQU√ç
            }
        };

        // Permitir a√±adir pulsando "Enter"
        document.getElementById('player-name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('add-player-btn').click();
        });

        // Funci√≥n auxiliar para persistir solo los nombres y colores elegidos
        function guardarNombresTemporales() {
            localStorage.setItem('loot_and_run_nombres_recientes', JSON.stringify(jugadoresTemporales));
        }

        function cargarNombresRecientes() {
            // Si NO hay una partida en curso, cargamos la lista previa
            if (!localStorage.getItem('loot_and_run_game_state')) {
                const guardados = localStorage.getItem('loot_and_run_nombres_recientes');
                if (guardados) {
                    jugadoresTemporales = JSON.parse(guardados);
                    actualizarVistaPreviaJugadores();
                }
            }
        }

        // Ejecutar al cargar
        cargarNombresRecientes();

    </script>

</body>

</html>